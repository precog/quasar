#!/usr/bin/env bash

TRAVIS_RETRY=$(command -v travis_retry)

deployCredentials() {
  ./scripts/credentials
}

if [[ $(command -v aws) = "1" ]]; then
  pip install --user awscli
fi

AWS=$(command -v aws)

checkTravisIP() {
  curl -s checkip.dyndns.org | sed -e 's/.*Current IP Address: //' -e 's/<.*$//'
}

downloadFromS3() {
  $TRAVIS_RETRY $AWS s3 --only-show-errors cp s3://quasar-build-cache/$TRAVIS_BUILD_NUMBER/$1 $1 --recursive
}

uploadToS3() {
  $TRAVIS_RETRY $AWS s3 --only-show-errors cp $1 s3://quasar-build-cache/$TRAVIS_BUILD_NUMBER/$1 --recursive
}

cleanUpS3() {
  $TRAVIS_RETRY $AWS s3 --only-show-errors rm s3://quasar-build-cache/$TRAVIS_BUILD_NUMBER --recursive
}

usage() {
  echo "Usage: ./scripts/s3Cache upload | download | cleanup"
}

if [[ $# -eq 0 ]]; then
  usage
  exit 1
fi

deployCredentials
echo "Trivs public IP is: $(checkTravisIP)"

if [[ "$1" = "upload" ]]; then
  uploadToS3 .targets
  uploadToS3 .hoarder-cache
  exit 0
elif [[ "$1" = "download" ]]; then
  downloadFromS3 .targets
  downloadFromS3 .hoarder-cache
  exit 0
elif [[ "$1" = "cleanup" ]]; then
  echo "cleaning up..."
  cleanUpS3
  exit 0
else
  usage
  exit 1
fi
